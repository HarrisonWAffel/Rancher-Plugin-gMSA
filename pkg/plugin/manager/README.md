# Rancher gMSA Plugin Manager 
This directory contains the source code for the Rancher gMSA Plugin Manager. This component is responsible for installing, uninstalling, and upgrading the Rancher CCG plugin DLL on Windows nodes. If you intend to run the gMSA Account Provider API in your cluster, you **must** first install the gMSA Plugin Manager.

## Installation
The CCG plugin DLL is installed using a small PowerShell script (`install-plugin.ps1`). This script will register the CCG plugin DLL onto the system using `regsvc.exe`. Additionally, the script will modify the Windows registry key `SYSTEM\CurrentControlSet\Control\CCG\COMClasses\` to include the CLSID of the plugin (`{e4781092-f116-4b79-b55e-28eb6a224e26}`). The actual DLL file and associated type library will be located in the `C:\Program Files\RanchergMSACredentialProvider` directory. 

## Uninstallation
The plugin DLL is uninstalled using an additional PowerShell script (`uninstall-plugin.ps1`) which also leverages the `regsvc.exe` command. During the uninstallation process the CCG plugin DLL file will be removed from the system, and a cleanup script will be generated in `C:\Program Files\RanchergMSACredentialProvider`. The cleanup script is responsible for removing the `/var/lib/rancher/gmsa` directory, which contains all the certificates and metadata generated by the Account Provider. Executing the cleanup script should only be done to fully remove the Rancher non-domain joined gMSA feature from the host, and it must be done manually. 

## Upgrades
The plugin DLL is upgraded following this procedure outlined by Microsoft in [their documentation](https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-updates).

## How do I Invoke The Rancher gMSA CCG Plugin? 
To instruct CCG to invoke the Rancher gMSA Plugin you must properly configure a `GMSACredentialSpec` resource to point to this plugin, and then start a Kubernetes pod utilizing that same GMSACredentialSpec. Here's an example `GMSACredentialSpec` object 

```yaml 
apiVersion: windows.k8s.io/v1
kind: GMSACredentialSpec
metadata:
  name: example_credential_spec
credspec:
  ActiveDirectoryConfig:
    GroupManagedServiceAccounts:
      - Name: <YOUR_MACHINE_ACCOUNT_NAME>
        Scope: <YOUR_NET_BIOS_NAME>
      - Name: <YOUR_MACHINE_ACCOUNT_NAME>
        Scope: <YOUR_DNS_NAME>
    HostAccountConfig:
      PortableCcgVersion: 1
      PluginGUID: '{e4781092-f116-4b79-b55e-28eb6a224e26}'
      PluginInput: <account-provider-namespace>:<kubernetes-secret>
  CmsPlugins:
    - ActiveDirectory
  DomainJoinConfig:
    DnsName: <YOUR_DNS_NAME>
    DnsTreeName:  <YOUR_DNS_TREE_NAME>
    Guid:  <YOUR_GUID_VALUE>
    MachineAccountName:  <YOUR_MACHINE_ACCOUNT_NAME>
    NetBiosName:  <YOUR_NET_BIOS_NAME>
    Sid:  <YOUR_SID_VALUE>
```
